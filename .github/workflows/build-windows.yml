name: Build (Windows)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Allow running repo scripts
        shell: pwsh
        run: Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass

      # 1) Detect the highest installed Windows SDK version and expose it for CMake
      - name: Detect Windows SDK
        id: winsdk
        shell: pwsh
        run: |
          $sdkRoot = 'C:\Program Files (x86)\Windows Kits\10\Lib'
          if (-not (Test-Path $sdkRoot)) { throw "Windows 10 SDK not found at $sdkRoot" }
          $versions = Get-ChildItem $sdkRoot -Directory | Select-Object -ExpandProperty Name
          if (-not $versions) { throw "No SDK versions found in $sdkRoot" }
          $highest = ($versions | Sort-Object {[version]$_} -Descending | Select-Object -First 1)
          "Detected SDK: $highest"
          echo "SDK=$highest" >> $env:GITHUB_OUTPUT

      # 2) Override repo presets:
      #    - set ENABLE_FRONTEND_API=ON, ENABLE_QT=ON
      #    - set CMAKE_VS_WINDOWS_TARGET_PLATFORM_VERSION to the detected SDK
      - name: Write CMakeUserPresets.json
        shell: pwsh
        run: |
          $sdk = '${{ steps.winsdk.outputs.SDK }}'
          $json = @{
            version = 4
            configurePresets = @(
              @{
                name = "windows-ci-x64"
                inherits = "windows-ci-x64"
                cacheVariables = @{
                  ENABLE_FRONTEND_API = "ON"
                  ENABLE_QT           = "ON"
                  CMAKE_VS_WINDOWS_TARGET_PLATFORM_VERSION = $sdk
                }
              }
            )
          } | ConvertTo-Json -Depth 8
          $json | Out-File -FilePath CMakeUserPresets.json -Encoding utf8
          Get-Content CMakeUserPresets.json

      # 3) Build via the template script (uses --preset windows-ci-x64)
      - name: Build via template script
        shell: pwsh
        run: ./.github/scripts/Build-Windows.ps1 -Configuration Release

      # 4) Upload artifacts
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: profile-switcher-windows
          path: |
            build/**/rundir/**/obs-plugins/**
            build/**/rundir/**/data/obs-plugins/**
