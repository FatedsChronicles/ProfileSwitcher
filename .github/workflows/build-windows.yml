name: Build (Windows)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      # Detect highest installed Windows SDK and pass it to CMake
      - name: Detect Windows SDK
        id: winsdk
        shell: pwsh
        run: |
          $sdkRoot = 'C:\Program Files (x86)\Windows Kits\10\Lib'
          if (-not (Test-Path $sdkRoot)) { throw "Windows 10 SDK not found at $sdkRoot" }
          $versions = Get-ChildItem $sdkRoot -Directory | Select-Object -ExpandProperty Name
          if (-not $versions) { throw "No SDK versions found in $sdkRoot" }
          $highest = ($versions | Sort-Object {[version]$_} -Descending | Select-Object -First 1)
          "Detected SDK: $highest"
          "SDK=$highest" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      # Configure with MSVC generator, no presets/scripts
      - name: CMake Configure (MSVC)
        shell: pwsh
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_VS_WINDOWS_TARGET_PLATFORM_VERSION=${{ steps.winsdk.outputs.SDK }} `
            -DENABLE_FRONTEND_API=ON `
            -DENABLE_QT=ON

      - name: CMake Build (Release)
        shell: pwsh
        run: cmake --build build --config Release -- /m

      - name: Show rundir
        shell: pwsh
        run: |
          Write-Host "Listing build output:"
          Get-ChildItem -Recurse build | Out-String -Width 4096

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: profile-switcher-windows
          path: |
            build/**/rundir/**/obs-plugins/**
            build/**/rundir/**/data/obs-plugins/**
          if-no-files-found: warn
