name: Build (Windows)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Allow running repo scripts
        shell: pwsh
        run: Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass

      - name: Detect Windows SDK
        id: winsdk
        shell: pwsh
        run: |
          $sdkRoot = 'C:\Program Files (x86)\Windows Kits\10\Lib'
          if (-not (Test-Path $sdkRoot)) { throw "Windows 10 SDK not found at $sdkRoot" }
          $versions = Get-ChildItem $sdkRoot -Directory | Select-Object -ExpandProperty Name
          if (-not $versions) { throw "No SDK versions found in $sdkRoot" }
          $highest = ($versions | Sort-Object {[version]$_} -Descending | Select-Object -First 1)
          "SDK=$highest" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Detected SDK: $highest"

      - name: Patch CMakePresets.json (enable frontend+Qt; fix SDK)
        shell: pwsh
        run: |
          $p = 'CMakePresets.json'
          $j = Get-Content $p -Raw | ConvertFrom-Json
          foreach ($cp in $j.configurePresets) {
            if ($cp.name -eq 'template') {
              if (-not $cp.cacheVariables) { $cp.cacheVariables = @{} }
              $cp.cacheVariables.ENABLE_FRONTEND_API = $true
              $cp.cacheVariables.ENABLE_QT = $true
            }
            if ($cp.name -eq 'windows-x64') {
              $cp.architecture = "x64,version=${{ steps.winsdk.outputs.SDK }}"
            }
          }
          $j | ConvertTo-Json -Depth 10 | Out-File -FilePath $p -Encoding utf8

      - name: Build via template script
        shell: pwsh
        run: ./.github/scripts/Build-Windows.ps1 -Configuration RelWithDebInfo

      - name: Install (if template uses install to stage outputs)
        shell: pwsh
        run: |
          if (Test-Path build_x64) { cmake --install build_x64 --config RelWithDebInfo }

      - name: Locate built plugin (.dll)
        id: finddll
        shell: pwsh
        run: |
          $dll = Get-ChildItem -Recurse -Filter 'profile-switcher*.dll' build_x64 | Select-Object -First 1
          if (-not $dll) { throw "No .dll found under build_x64" }
          "DLL=$($dll.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Found: $($dll.FullName)"

      - name: Package OBS layout
        shell: pwsh
        run: |
          $Dist = "dist\profile-switcher-windows"
          New-Item -ItemType Directory -Force -Path "$Dist\obs-plugins" | Out-Null
          New-Item -ItemType Directory -Force -Path "$Dist\data\obs-plugins\profile-switcher\locale" | Out-Null
          Copy-Item "${{ steps.finddll.outputs.DLL }}" "$Dist\obs-plugins\profile-switcher.dll"
          if (Test-Path "data\locale\en-US.ini") {
            Copy-Item "data\locale\en-US.ini" "$Dist\data\obs-plugins\profile-switcher\locale\en-US.ini"
          }
          Compress-Archive -Path "dist\profile-switcher-windows\*" -DestinationPath "profile-switcher-windows.zip" -Force
          Get-ChildItem -Recurse dist | ForEach-Object { $_.FullName }

      - name: Upload plugin ZIP (ready to copy into OBS)
        uses: actions/upload-artifact@v4
        with:
          name: profile-switcher-windows-zip
          path: profile-switcher-windows.zip

      - name: Upload builddir (fallback)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: profile-switcher-windows-builddir
          path: build_x64
          if-no-files-found: warn
