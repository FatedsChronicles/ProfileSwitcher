name: Build (Windows)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Allow running repo scripts
        shell: pwsh
        run: Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass

      - name: Detect Windows SDK
        id: winsdk
        shell: pwsh
        run: |
          $sdkRoot = 'C:\Program Files (x86)\Windows Kits\10\Lib'
          if (-not (Test-Path $sdkRoot)) { throw "Windows 10 SDK not found at $sdkRoot" }
          $versions = Get-ChildItem $sdkRoot -Directory | Select-Object -ExpandProperty Name
          if (-not $versions) { throw "No SDK versions found in $sdkRoot" }
          $highest = ($versions | Sort-Object {[version]$_} -Descending | Select-Object -First 1)
          "SDK=$highest" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Detected SDK: $highest"

      - name: Patch CMakePresets.json (enable frontend+Qt; fix SDK entry)
        shell: pwsh
        run: |
          $p = 'CMakePresets.json'
          $j = Get-Content $p -Raw | ConvertFrom-Json
          foreach ($cp in $j.configurePresets) {
            if ($cp.name -eq 'template') {
              if (-not $cp.cacheVariables) { $cp.cacheVariables = @{} }
              $cp.cacheVariables.ENABLE_FRONTEND_API = $true
              $cp.cacheVariables.ENABLE_QT = $true
            }
            if ($cp.name -eq 'windows-x64') {
              $cp.architecture = "x64,version=${{ steps.winsdk.outputs.SDK }}"
            }
          }
          $j | ConvertTo-Json -Depth 10 | Out-File -FilePath $p -Encoding utf8

      - name: Build via template script
        shell: pwsh
        run: ./.github/scripts/Build-Windows.ps1 -Configuration RelWithDebInfo

      - name: Install (ensure rundir exists)
        shell: pwsh
        run: |
          if (Test-Path build_x64) { cmake --install build_x64 --config RelWithDebInfo }

      - name: List outputs
        shell: pwsh
        run: |
          Write-Host "==== build_x64 tree ===="
          Get-ChildItem -Recurse -Force build_x64 | ForEach-Object { $_.FullName }

      - name: Upload plugin folders (preferred)
        uses: actions/upload-artifact@v4
        with:
          name: profile-switcher-windows
          path: |
            build_x64/**/rundir/**/obs-plugins/**
            build_x64/**/rundir/**/data/obs-plugins/**

      - name: Upload fallback (entire build dir)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: profile-switcher-windows-builddir
          path: build_x64
          if-no-files-found: warn
