name: Build (Ubuntu)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1) Ensure zsh exists (template script uses zsh shebang)
      - name: Install zsh
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh

      # 2) Create a CMakeUserPresets.json that overrides repo presets:
      #    - ENABLE_FRONTEND_API=ON
      #    - ENABLE_QT=ON
      - name: Write CMakeUserPresets.json
        run: |
          cat > CMakeUserPresets.json << 'EOF'
          {
            "version": 4,
            "configurePresets": [
              {
                "name": "ubuntu-ci",
                "inherits": "ubuntu-ci",
                "cacheVariables": {
                  "ENABLE_FRONTEND_API": "ON",
                  "ENABLE_QT": "ON"
                }
              }
            ]
          }
          EOF

      # 3) Make repo helper script executable (template path)
      - name: Make scripts executable
        run: |
          chmod +x .github/scripts/build-ubuntu

      # 4) Build via the template script (it uses the preset; our user preset overrides)
      - name: Build via template script
        run: .github/scripts/build-ubuntu

      # 5) Upload artifacts (plugin binary + data folder if present)
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: profile-switcher-ubuntu
          path: |
            build/**/rundir/**/obs-plugins/**
            build/**/rundir/**/data/obs-plugins/**
