name: Build (macOS)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      # 1) Override repo presets so our dock requirements are enabled
      - name: Write CMakeUserPresets.json
        run: |
          cat > CMakeUserPresets.json << 'EOF'
          {
            "version": 4,
            "configurePresets": [
              {
                "name": "macos-ci-universal",
                "inherits": "macos-ci-universal",
                "cacheVariables": {
                  "ENABLE_FRONTEND_API": "ON",
                  "ENABLE_QT": "ON"
                }
              }
            ]
          }
          EOF

      # 2) Ensure helper script is executable
      - name: Make scripts executable
        run: chmod +x .github/scripts/build-macos

      # 3) Build via the template script (uses preset macos-ci-universal)
      - name: Build via template script
        run: .github/scripts/build-macos

      # 4) Upload artifacts
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: profile-switcher-macos
          path: |
            build/**/rundir/**/obs-plugins/**
            build/**/rundir/**/data/obs-plugins/**
